{% extends "base.html" %}

{% block title %}Dashboard - MMR Competitive Ladder{% endblock %}

{% block content %}
<div class="row">
    <!-- Current Week Info -->
    <div class="col-12 mb-4">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h2 class="card-title mb-0">
                    <i class="fas fa-calendar-week me-2"></i>
                    {{ dashboard_title or ('Week ' ~ (current_week - 1) ~ ' Complete - Week ' ~ current_week ~ ' Starting') }}
                </h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Current Standings (Top 5) -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>Current Standings
                </h5>
                <a href="{{ url_for('leaderboard') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Team</th>
                                <th>MMR</th>
                                <th>Record</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for team in teams[:5] %}
                            <tr>
                                <td>
                                    <span class="badge bg-{{ 'warning' if loop.index == 1 else 'secondary' if loop.index <= 3 else 'light text-dark' }}">
                                        {{ loop.index }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            {% if team.logo %}
                                                <img src="{{ team.logo }}" alt="{{ team.name }} logo" class="rounded" style="width:32px;height:32px;object-fit:cover;">
                                            {% else %}
                                                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width:32px;height:32px;">
                                                    <i class="fas fa-shield-alt text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h6 class="mb-0">
                                                <a href="{{ url_for('team_detail', team_name=team.name) }}" class="text-decoration-none">{{ team.name }}</a>
                                            </h6>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="mmr-badge">{{ team.mmr }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-primary me-2">{{ team.wins }} - {{ team.losses }}</span>
                                        <small class="text-muted">(W-L)</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if team.active else 'danger' }}">
                                        {{ 'Active' if team.active else 'Inactive' }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Matches -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recent Matches
                </h5>
                <a href="{{ url_for('matches') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if recent_matches %}
                <div class="row">
                    {% for match in recent_matches %}
                    {% set team_a_obj = all_teams | selectattr('name', 'equalto', match.team_a) | first %}
                    {% set team_b_obj = all_teams | selectattr('name', 'equalto', match.team_b) | first %}
                    {% set winner = team_a_obj if (match.completed and match.score and match.score[0] > match.score[1]) else (team_b_obj if (match.completed and match.score and match.score[1] > match.score[0]) else none) %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card match-card {{ 'match-completed' if match.completed else 'match-pending' }}" 
                             {% if winner %}style="border-left: 4px solid {{ winner.hexcolor or '#6366f1' }};"{% endif %}>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <small class="text-muted">Week {{ match.week }}</small>
                                    {% set match_status = match.get_status() %}
                                    <span class="badge bg-{{ 'success' if match_status == 'completed' else ('warning' if match_status == 'scheduled' else 'danger') }}">
                                        {{ 'Completed' if match_status == 'completed' else ('Scheduled' if match_status == 'scheduled' else 'Unscheduled') }}
                                    </span>
                                </div>
                                
                                <!-- Enhanced team display with logos and winner styling -->
                                <div class="match-teams mb-2">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            {% if team_a_obj and team_a_obj.logo %}
                                                <img src="{{ team_a_obj.logo }}" alt="{{ match.team_a }} logo" 
                                                     class="rounded me-2" style="width:24px;height:24px;object-fit:cover;">
                                            {% else %}
                                                <div class="d-flex align-items-center justify-content-center bg-light rounded me-2" style="width:24px;height:24px;">
                                                    <i class="fas fa-shield-alt text-muted" style="font-size:12px;"></i>
                                                </div>
                                            {% endif %}
                                            <span class="{{ 'fw-bold' if winner and winner.name == match.team_a else '' }}">
                                                {{ match.team_a }}
                                                {% if match.completed and match.mmr_delta_a is not none %}
                                                    <span class="text-muted">({{ '+' if match.mmr_delta_a >= 0 else '' }}{{ match.mmr_delta_a }})</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% if match.completed and match.score %}
                                            <span class="badge bg-primary">{{ match.score[0] }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="text-center my-1">
                                        <small class="text-muted">vs</small>
                                    </div>
                                    
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            {% if team_b_obj and team_b_obj.logo %}
                                                <img src="{{ team_b_obj.logo }}" alt="{{ match.team_b }} logo" 
                                                     class="rounded me-2" style="width:24px;height:24px;object-fit:cover;">
                                            {% else %}
                                                <div class="d-flex align-items-center justify-content-center bg-light rounded me-2" style="width:24px;height:24px;">
                                                    <i class="fas fa-shield-alt text-muted" style="font-size:12px;"></i>
                                                </div>
                                            {% endif %}
                                            <span class="{{ 'fw-bold' if winner and winner.name == match.team_b else '' }}">
                                                {{ match.team_b }}
                                                {% if match.completed and match.mmr_delta_b is not none %}
                                                    <span class="text-muted">({{ '+' if match.mmr_delta_b >= 0 else '' }}{{ match.mmr_delta_b }})</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% if match.completed and match.score %}
                                            <span class="badge bg-primary">{{ match.score[1] }}</span>
                                        {% endif %}
                                    </div>
                                </div>

                                {% if match.completed %}
                                    <!-- Set Scores -->
                                    <p class="card-text mb-0">
                                        <strong>Set Scores:</strong> 
                                        {% if match.set_scores %}
                                            {% for set_score in match.set_scores %}
                                                <span class="badge bg-light text-dark me-1">{{ set_score }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">No set scores</span>
                                        {% endif %}
                                    </p>
                                {% else %}
                                    <p class="card-text text-muted">Match not yet played</p>
                                {% endif %}
                                
                                <div class="mt-2">
                                    <a href="{{ url_for('match_detail', match_id=match.match_id) }}" class="btn btn-sm btn-outline-primary">
                                        View Details
                                    </a>
                                    {% if not match.completed %}
                                    <a href="{{ url_for('input_result', match_id=match.match_id) }}" class="btn btn-sm btn-success">
                                        Input Result
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No matches found. Generate some matches to get started!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Current Week Matches -->
{% if week_matches %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day me-2"></i>Week {{ current_week - 1 }} Matches
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Match ID</th>
                                <th>Team A</th>
                                <th>Score</th>
                                <th>Team B</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for match in week_matches %}
                            <tr>
                                <td><code>{{ match.match_id }}</code></td>
                                <td>{{ match.team_a }}</td>
                                <td>
                                    {% if match.score %}
                                        <span class="badge bg-success">{{ match.score[0] }}-{{ match.score[1] }}</span>
                                    {% else %}
                                        <span class="text-muted">Pending</span>
                                    {% endif %}
                                </td>
                                <td>{{ match.team_b }}</td>
                                <td>
                                    {% set match_status = match.get_status() %}
                                    <span class="badge bg-{{ 'success' if match_status == 'completed' else ('warning' if match_status == 'scheduled' else 'danger') }}">
                                        {{ 'Completed' if match_status == 'completed' else ('Scheduled' if match_status == 'scheduled' else 'Unscheduled') }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('match_detail', match_id=match.match_id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if not match.completed %}
                                    <a href="{{ url_for('input_result', match_id=match.match_id) }}" class="btn btn-sm btn-success">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
