{% extends "base.html" %}

{% block title %}Admin Panel - MMR Competitive Ladder{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card bg-gradient text-white" style="background: linear-gradient(45deg, #dc3545 0%, #fd7e14 100%);">
            <div class="card-body text-center">
                <h2 class="card-title mb-3">
                    <i class="fas fa-shield-alt me-2"></i>Administrative Panel
                </h2>
                <p class="mb-0">Manage teams, matches, and system settings</p>
            </div>
        </div>
    </div>
</div>

<!-- Refresh Data Button -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-body text-center">
                <h5 class="card-title text-success mb-3">
                    <i class="fas fa-sync-alt me-2"></i>Data Refresh
                </h5>
                <p class="card-text mb-3">Reload all data sources to see the latest changes without restarting the server</p>
                <button id="refreshDataBtn" class="btn btn-success btn-lg" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh All Data
                </button>
                <div id="refreshStatus" class="mt-2" style="display: none;">
                    <span class="spinner-border spinner-border-sm text-success me-2" role="status"></span>
                    <span class="text-success">Refreshing data...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Team Management -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Team Management
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('manage_teams') }}" class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-edit me-2"></i>Edit Team Rosters
                    </a>
                    <a href="{{ url_for('create_team') }}" class="btn btn-outline-success btn-lg">
                        <i class="fas fa-plus me-2"></i>Create New Team
                    </a>
                    <a href="{{ url_for('teams') }}" class="btn btn-outline-info">
                        <i class="fas fa-eye me-2"></i>View All Teams
                    </a>
                    <button class="btn btn-outline-secondary btn-lg" data-bs-toggle="modal" data-bs-target="#importTeamModal">
                        <i class="fas fa-file-import me-2"></i>Import Team JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Match Management -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-gamepad me-2"></i>Match Management
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('generate_matches') }}" class="btn btn-outline-success btn-lg">
                        <i class="fas fa-calendar-plus me-2"></i>Generate New Week
                    </a>
                    <a href="{{ url_for('matches') }}" class="btn btn-outline-info">
                        <i class="fas fa-eye me-2"></i>View All Matches
                    </a>
                    <a href="{{ url_for('manage_matches') }}" class="btn btn-outline-warning">
                        <i class="fas fa-edit me-2"></i>Edit Matches
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- System Management -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>System Settings
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('system_settings') }}" class="btn btn-outline-warning btn-lg">
                        <i class="fas fa-sliders-h me-2"></i>MMR Settings
                    </a>
                    <a href="{{ url_for('backup_data') }}" class="btn btn-outline-info">
                        <i class="fas fa-download me-2"></i>Backup Data
                    </a>
                    <a href="{{ url_for('restore_data') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-upload me-2"></i>Restore Data
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button id="quickRefreshBtn" class="btn btn-outline-success btn-lg" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                    <a href="{{ url_for('apply_inactivity_penalties') }}" class="btn btn-outline-danger btn-lg">
                        <i class="fas fa-clock me-2"></i>Apply Inactivity Penalties
                    </a>
                    <a href="{{ url_for('reset_week') }}" class="btn btn-outline-warning">
                        <i class="fas fa-redo me-2"></i>Reset Current Week
                    </a>
                    <a href="{{ url_for('export_data') }}" class="btn btn-outline-success">
                        <i class="fas fa-file-export me-2"></i>Export Data
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Status -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-primary">{{ teams|length }}</h4>
                            <small class="text-muted">Total Teams</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-success">{{ matches|length }}</h4>
                            <small class="text-muted">Total Matches</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-info">{{ current_week }}</h4>
                            <small class="text-muted">Current Week</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-warning">{{ matches|rejectattr('completed')|list|length }}</h4>
                            <small class="text-muted">Pending Matches</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Database Status -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-secondary">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-database me-2"></i>Database Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Backend:</strong> {{ db_status.backend if db_status else 'unknown' }}</li>
                            <li class="list-group-item"><strong>DB Path:</strong> {{ db_status.db_path or 'N/A' }}</li>
                            <li class="list-group-item"><strong>DB Size (bytes):</strong> {{ db_status.db_size_bytes or 'N/A' }}</li>
                            <li class="list-group-item"><strong>Teams (in memory):</strong> {{ db_status.teams_count if db_status else teams|length }}</li>
                            <li class="list-group-item"><strong>Matches (in memory):</strong> {{ db_status.matches_count if db_status else matches|length }}</li>
                            <li class="list-group-item"><strong>Legacy JSON present:</strong> {{ db_status.legacy_json_present if db_status else 'False' }}</li>
                        </ul>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-center">
                        <form method="POST" action="{{ url_for('admin_remigrate') }}" onsubmit="return confirm('This will replace DB contents with data from legacy JSON files if present. Continue?');">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-exchange-alt me-2"></i>Re-import from Legacy JSON
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manage Matches -->
<div class="row">
    <div class="col-12">
        <h3>Manage Matches</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Match ID</th>
                    <th>Team A</th>
                    <th>Team B</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for match in matches %}
                <tr>
                    <td>{{ match.match_id }}</td>
                    <td>{{ match.team_a }}</td>
                    <td>{{ match.team_b }}</td>
                    <td>
                        <form method="POST" action="{{ url_for('delete_match', match_id=match.match_id) }}">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Removed Simulate Match Log button section -->

<div class="row mt-4">
    <div class="col-12">
        <h4>Update Current Week</h4>
        <form action="{{ url_for('update_week') }}" method="POST">
            <div class="input-group mb-3">
                <input type="number" name="new_week" class="form-control" placeholder="Enter new week number" required>
                <button class="btn btn-primary" type="submit">Update Week</button>
            </div>
        </form>
    </div>
</div>

<!-- Security Notice -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Security Notice:</strong> You are currently logged in as an administrator. 
            All changes made in this panel will affect the live system. 
            <a href="{{ url_for('admin_logout') }}" class="alert-link">Logout</a> when finished.
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12 text-center">
        <button class="btn btn-danger" id="resetDataButton">Reset All Data</button>
    </div>
</div>

<!-- Import Team Modal -->
<div class="modal fade" id="importTeamModal" tabindex="-1" aria-labelledby="importTeamModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="importTeamModalLabel"><i class="fas fa-file-import me-2"></i>Import Team from JSON</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('admin_import_team') }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="teamJsonTextarea" class="form-label">Paste team JSON</label>
            <textarea id="teamJsonTextarea" name="team_json" class="form-control" rows="12" placeholder='{"name":"Team X","mmr":1000,"active":true,"roster":[{"name":"Player 1","role":"DPS"}]}' required></textarea>
            <div class="form-text">
              Accepts a single team object, an array of team objects, or {"teams": [ ... ]}. Existing team names are skipped.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Import</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function refreshData() {
    // Show loading state
    document.getElementById('refreshStatus').style.display = 'block';
    document.getElementById('refreshDataBtn').disabled = true;
    document.getElementById('quickRefreshBtn').disabled = true;
    
    // Make AJAX request to refresh endpoint
    fetch('/admin/refresh_data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            document.getElementById('refreshStatus').innerHTML = 
                '<i class="fas fa-check-circle text-success me-2"></i>' +
                '<span class="text-success">Data refreshed successfully!</span>';
            
            // Reload the page after a short delay to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            // Show error message
            document.getElementById('refreshStatus').innerHTML = 
                '<i class="fas fa-exclamation-triangle text-danger me-2"></i>' +
                '<span class="text-danger">Error refreshing data: ' + data.message + '</span>';
        }
    })
    .catch(error => {
        // Show error message
        document.getElementById('refreshStatus').innerHTML = 
            '<i class="fas fa-exclamation-triangle text-danger me-2"></i>' +
            '<span class="text-danger">Error refreshing data: ' + error.message + '</span>';
    })
    .finally(() => {
        // Re-enable buttons after a delay
        setTimeout(() => {
            document.getElementById('refreshDataBtn').disabled = false;
            document.getElementById('quickRefreshBtn').disabled = false;
            document.getElementById('refreshStatus').style.display = 'none';
        }, 3000);
    });
}

// Hook up Reset All Data button
window.addEventListener('DOMContentLoaded', function() {
    const resetBtn = document.getElementById('resetDataButton');
    if (!resetBtn) return;
    resetBtn.addEventListener('click', async function() {
        if (!confirm('This will reset all teams, matches, and the week counter. Continue?')) return;
        resetBtn.disabled = true;
        try {
            const resp = await fetch('/reset_data', { method: 'POST' });
            if (resp.ok) {
                alert('Data reset successfully.');
                window.location.reload();
            } else {
                const txt = await resp.text();
                alert('Error resetting data: ' + txt);
            }
        } catch (e) {
            alert('Error resetting data: ' + (e?.message || e));
        } finally {
            resetBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}
